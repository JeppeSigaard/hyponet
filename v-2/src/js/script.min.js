// @koala-append 'assets/assets.js';
// @koala-append 'modules/modules.js';



//@koala-append 'formclick.js';
//@koala-append 'logclick.js';
//@koala-append 'init.js';

var clickhandlerForm = function(form,log){
form.on('click keypress',function(event){
    
    var target = $(event.target),
        input = form.children('input');
    
    
    
    if(target.is('a') || event.which == 13){
    
        event.preventDefault();
        
        var log_obj = $('<div></div>');
        log_obj.append(input.val());
        log.append(log_obj);
        
        var data = form.serialize();
    
        input.val('');
        
        $.ajax({
            url : 'src/php/writeString.php',
            type : 'POST',
            data : data,
            dataType : 'json',
            success : function(response){
                
                
            },
        });
        
    }

});

}

var submitObject = function(one,two,obj){
    
    var data = {
        'one' : one,
        'two' : two, 
    }
    
    $.ajax({
        url : 'src/php/writeObject.php',
        type : 'POST',
        data : data,
        dataType : 'json',
        success : function(response){
        },
    });
    
}

var clickhandlerLog = function(log){

    var one,two;
    
    log.on('click',function(event){
        var target = $(event.target);
        if ( !target.is('.editing') && target.is('div') ){
            
            
            $('.editing').removeClass('editing').removeAttr('contentEditable').html(one);
            
            
            one = target.html(),
            two = '';
            
            target.attr('contentEditable',true).addClass('editing');
        
        }
    }).on('keypress',function(event){
        var target = $(event.target);
        if(target.is('.editing') && target.is('div')){
            
            if ( event.which == 13 ){
                
                event.preventDefault();
                target.removeClass('editing').removeAttr('contentEditable').blur();
                two = target.html().replace('  ',' ').trim();
                submitObject(one,two,target);
                
                one = '';
                two = '';
            }
        }

    });
}

$(function(){

    // Hent hjernen
    var brain = $.getJSON('src/data/brain.json'),
        brainData;
    
    // Tjek at der findes en hjerne
    brain.fail(function(){console.log('Error fetching brain');});

    // opret hyponet container, hvis den mangler
    if(!$('#hyponet').length){
        console.log('container not found, auto creating');
        var hyponet = $('<div id="hyponet"></div>');
        $('body').prepend(hyponet);
    }
    // Definer container
    var hyponet = $('#hyponet');
    
    
    // definer styleheet
    var style = $('<link>');
    style.attr({
        'rel':'stylesheet',
        'href': 'src/css/style.css',
    });
    
    $('head').append(style);
    
    
    
    // Hjernen er klar
    brain.done(function(){
    
        // Kontruer log
        var log = $('<div class="hyponet-log"></div>'),
            logWrap = $('<div class="hyponet-log-wrapper"></div>');
        brainData = brain.responseJSON;
        var brainLength = Object.keys(brainData).length,
            brainIteration = 0;
        
        $.each(brainData, function(i, val) {
            
            if($.type(val) !== 'string'){
                brainLength --;
            }
            
            else {
                brainIteration ++;
                if(brainIteration > brainLength - 10){
                    log.append('<div>'+val+'</div>');
                }
            }
        });
        
        logWrap.append(log);
        hyponet.append(logWrap);
        clickhandlerLog(log);
    
    
        // Konstruer form
        var form = $('<form class="hyponet-form"></form>'),
            input = $('<input type="text" name="data">'),
            send = $('<a href="#">send</a>');
        form.append(input).append(send);
        hyponet.append(form);
        clickhandlerForm(form,log);
        
        
        // Konstruer taler√∏r
        var speak = $('<div class="hyponet-speak"></div>');
        hyponet.append(speak);
    });
});